<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>criSys</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Materialize CSS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Materialize Icons CDN -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Font Awesome Icons CDN -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf"
    crossorigin="anonymous">
  <!-- Main CSS (If not loading, Ctrl + F5)-->
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" type="text/css">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
      height: 91vh;
      width: 100%
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 98%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <nav>
    <div class="nav-wrapper blue darken-3">
      <a href="#" class="brand-logo"><i class="material-icons left brand-icon">flash_on</i>criSys</a>
      <ul id="nav-mobile" class="right hide-on-med-and-down">
        <li>
          <span><a href="{{ url_for('chat') }}"><i class="fas fa-sm fa-comment-alt"></i></a></span>
        </li>
        <li>
          <span><a href="{{ url_for('contacts') }}"><i class="fas fa-sm fa-users"></i></a></span>
        </li>
        <li>
          <span><a href="#"><i class="fas fa-sm fa-exclamation-circle"></i></a></span>
        </li>
      </ul>
    </div>
  </nav>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div>
    {{ message }}
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  {% block content %}
  <div id="map"></div>
  <script>
    function initMap() {
      var uluru = { lat: -25.363, lng: 131.044 };
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 4,
        center: uluru
      });

      var marker = new google.maps.Marker({
        position: uluru,
        map: map,
        title: 'Uluru (Ayers Rock)'
      });

      google.maps.event.addListener(map, 'click', function(event) {
          placeMarker(event.latLng); // Event.laglng.lat() add to database
          const latitude = event.latLng.lat();
          const longtitude = event.latLng.lng();
          newPins({latitude: latitude, longtitude: longtitude});
      });

      const getPins = () => {
          return fetch('{{ api_url }}').then(res => res.json())
      }

      getPins().then(function(result) {
          for(let i in result) {
              let pin = result[i];
              console.log(pin);
              let location = {lat: parseFloat(pin.latitude), lng: parseFloat(pin.longitude)};
              placeMarker(location);
          }
      });

      const placeMarker = location => {
          const marker = new google.maps.Marker({
              position: location,
              map: map
          });
      }

      const newPins = pin => {
          const options = {
              method: 'POST',
              body: JSON.stringify(pin),
              headers: new Headers({
                  'Content-type': 'application/json'
              })
          }
          return fetch('{{ api_url }}', options)
              .then(res => res.json())
              .then(res => console.log(res))
              .catch(error => console.error('Error: ${error}'))
      }
  }    
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBJasvCiLPTsX0LJ_Fwp883mst4cQ3bSgM&libraries=drawing&callback=initMap" async defer></script>
  {% endblock %}
  <!-- jQuery JS -->
  <script 
    src="https://code.jquery.com/jquery-3.4.0.slim.min.js" 
    integrity="sha256-ZaXnYkHGqIhqTbJ6MB4l9Frs/r7U4jlx7ir8PJYBqbI="
    crossorigin="anonymous">
    </script>
  <!-- Materilize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Custom JS -->
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>